<Page
    x:Class="MagiDesk.Frontend.Views.CajaReportsPage"
    x:Name="PageRoot"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:conv="using:MagiDesk.Frontend.Converters"
    mc:Ignorable="d"
    Background="{ThemeResource ApplicationPageBackgroundThemeBrush}">
    <Page.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibilityConverter"/>
        <conv:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
    </Page.Resources>

    <Grid Margin="20">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>

        <!-- Header -->
        <StackPanel Grid.Row="0" Margin="0,0,0,20">
            <TextBlock Text="Caja Report" 
                       Style="{StaticResource TitleTextBlockStyle}" 
                       FontSize="32" 
                       FontWeight="Bold"/>
            <TextBlock Text="Detailed session report" 
                       Style="{StaticResource BodyTextBlockStyle}" 
                       Foreground="{ThemeResource SystemControlForegroundBaseMediumBrush}"
                       Margin="0,8,0,0"/>
        </StackPanel>

        <!-- Report Content -->
        <ScrollViewer Grid.Row="2" VerticalScrollBarVisibility="Auto">
            <StackPanel Spacing="16">
                <!-- Summary Card -->
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="8"
                        Padding="20"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Resumen de Sesión" 
                                   Style="{StaticResource SubtitleTextBlockStyle}" 
                                   FontSize="18" 
                                   FontWeight="SemiBold"/>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel Grid.Column="0" Spacing="8">
                                <TextBlock>
                                    <Run Text="Abierta: "/>
                                    <Run Text="{x:Bind ViewModel.OpenedAtFormatted, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock>
                                    <Run Text="Cerrada: "/>
                                    <Run Text="{x:Bind ViewModel.ClosedAtFormatted, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock>
                                    <Run Text="Abierta por: "/>
                                    <Run Text="{x:Bind ViewModel.Report.OpenedByUserId, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock Visibility="{x:Bind ViewModel.Report.ClosedByUserId, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                                    <Run Text="Cerrada por: "/>
                                    <Run Text="{x:Bind ViewModel.Report.ClosedByUserId, Mode=OneWay}"/>
                                </TextBlock>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="1" Spacing="8">
                                <TextBlock>
                                    <Run Text="Monto inicial: "/>
                                    <Run Text="{x:Bind ViewModel.OpeningAmountFormatted, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock Visibility="{x:Bind ViewModel.Report.ClosingAmount, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                                    <Run Text="Monto final: "/>
                                    <Run Text="{x:Bind ViewModel.ClosingAmountFormatted, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock>
                                    <Run Text="Total calculado: "/>
                                    <Run Text="{x:Bind ViewModel.SystemTotalFormatted, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock Visibility="{x:Bind ViewModel.Report.Difference, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}">
                                    <Run Text="Diferencia: "/>
                                    <Run Text="{x:Bind ViewModel.DifferenceFormatted, Mode=OneWay}"/>
                                </TextBlock>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Transactions Card -->
                <Border Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="8"
                        Padding="20"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1">
                    <StackPanel Spacing="12">
                        <TextBlock Text="Desglose de Transacciones" 
                                   Style="{StaticResource SubtitleTextBlockStyle}" 
                                   FontSize="18" 
                                   FontWeight="SemiBold"/>
                        
                        <Grid>
                            <Grid.ColumnDefinitions>
                                <ColumnDefinition Width="*"/>
                                <ColumnDefinition Width="*"/>
                            </Grid.ColumnDefinitions>
                            
                            <StackPanel Grid.Column="0" Spacing="8">
                                <TextBlock>
                                    <Run Text="Ventas: "/>
                                    <Run Text="{x:Bind ViewModel.SalesTotalFormatted, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock>
                                    <Run Text="Propinas: "/>
                                    <Run Text="{x:Bind ViewModel.TipsTotalFormatted, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock>
                                    <Run Text="Depósitos: "/>
                                    <Run Text="{x:Bind ViewModel.DepositsTotalFormatted, Mode=OneWay}"/>
                                </TextBlock>
                            </StackPanel>
                            
                            <StackPanel Grid.Column="1" Spacing="8">
                                <TextBlock>
                                    <Run Text="Reembolsos: "/>
                                    <Run Text="{x:Bind ViewModel.RefundsTotalFormatted, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock>
                                    <Run Text="Retiros: "/>
                                    <Run Text="{x:Bind ViewModel.WithdrawalsTotalFormatted, Mode=OneWay}"/>
                                </TextBlock>
                                <TextBlock>
                                    <Run Text="Total de transacciones: "/>
                                    <Run Text="{x:Bind ViewModel.Report.TransactionCount, Mode=OneWay}"/>
                                </TextBlock>
                            </StackPanel>
                        </Grid>
                    </StackPanel>
                </Border>

                <!-- Notes -->
                <Border Visibility="{x:Bind ViewModel.Report.Notes, Mode=OneWay, Converter={StaticResource NullToVisibilityConverter}}"
                        Background="{ThemeResource CardBackgroundFillColorDefaultBrush}"
                        CornerRadius="8"
                        Padding="20"
                        BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                        BorderThickness="1">
                    <StackPanel>
                        <TextBlock Text="Notas" 
                                   Style="{StaticResource SubtitleTextBlockStyle}" 
                                   FontSize="18" 
                                   FontWeight="SemiBold"
                                   Margin="0,0,0,8"/>
                        <TextBlock Text="{x:Bind ViewModel.Report.Notes, Mode=OneWay}"
                                   TextWrapping="Wrap"/>
                    </StackPanel>
                </Border>

                <!-- Actions -->
                <StackPanel Orientation="Horizontal" Spacing="12" HorizontalAlignment="Right">
                    <Button Content="Exportar PDF" 
                            Click="ExportPdfButton_Click"
                            Style="{StaticResource DefaultButtonStyle}"/>
                    <Button Content="Exportar CSV" 
                            Click="ExportCsvButton_Click"
                            Style="{StaticResource DefaultButtonStyle}"/>
                </StackPanel>
            </StackPanel>
        </ScrollViewer>

        <!-- Loading Indicator -->
        <ProgressRing Grid.Row="2"
                      IsActive="{x:Bind ViewModel.IsLoading, Mode=OneWay}"
                      Width="50"
                      Height="50"
                      HorizontalAlignment="Center"
                      VerticalAlignment="Center"
                      Visibility="{x:Bind ViewModel.IsLoading, Mode=OneWay, Converter={StaticResource BoolToVisibilityConverter}}"/>
    </Grid>
</Page>
