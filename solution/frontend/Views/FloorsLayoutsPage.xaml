<Page
    x:Class="MagiDesk.Frontend.Views.FloorsLayoutsPage"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:local="using:MagiDesk.Frontend.Views"
    xmlns:vm="using:MagiDesk.Frontend.ViewModels"
    xmlns:conv="using:MagiDesk.Frontend.Converters"
    xmlns:controls="using:MagiDesk.Frontend.Controls"
    mc:Ignorable="d">
    
    <Page.Resources>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <conv:StringToVisibilityConverter x:Key="StringToVisibility"/>
        <conv:StringToBoolConverter x:Key="StringToBool"/>
        <conv:NullToVisibilityConverter x:Key="NullToVisibilityConverter"/>
        <conv:NotNullToVisibilityConverter x:Key="NotNullToVisibilityConverter"/>
        <conv:NotNullToBoolConverter x:Key="NotNullToBoolConverter"/>
        <conv:StatusToColorConverter x:Key="StatusToColorConverter"/>
        <conv:TableCountConverter x:Key="TableCountConverter"/>
        <conv:PercentageConverter x:Key="PercentageConverter"/>
    </Page.Resources>
    
    <Page.DataContext>
        <vm:FloorsLayoutsViewModel x:Name="PageViewModel"/>
    </Page.DataContext>
    
    <Grid Background="{ThemeResource MicaAltBackgroundBrush}">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <!-- Command Bar -->
        <CommandBar Grid.Row="0" 
                    Style="{StaticResource FluentCommandBarStyle}"
                    DefaultLabelPosition="Right">
            <AppBarButton Icon="Add" Label="Add Floor" Click="AddFloor_Click"/>
            <AppBarButton Icon="Copy" Label="Duplicate Floor" Click="DuplicateFloor_Click" IsEnabled="{Binding SelectedFloor, Converter={StaticResource NotNullToBoolConverter}}"/>
            <AppBarSeparator/>
            <AppBarButton Icon="Save" Label="Save Layout" Command="{Binding SaveLayoutCommand}"/>
            <AppBarButton Icon="Refresh" Label="Refresh" Command="{Binding LoadFloorsCommand}"/>
            <AppBarButton Icon="Setting" Label="Layout Settings" Click="SettingsButton_Click"/>
        </CommandBar>
        
        <!-- Main Content: Split View -->
        <Grid Grid.Row="1">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="280" MinWidth="200"/>
                <ColumnDefinition Width="*"/>
                <ColumnDefinition Width="320" MinWidth="280"/>
            </Grid.ColumnDefinitions>
            
            <!-- Left: Floors Navigation -->
            <Border Grid.Column="0" 
                    Background="{StaticResource AcrylicCardBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="0,0,1,0">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="*"/>
                    </Grid.RowDefinitions>
                    
                    <!-- Floors Header -->
                    <StackPanel Grid.Row="0" 
                                 Padding="16"
                                 Background="{ThemeResource ControlFillColorDefaultBrush}">
                        <TextBlock Text="Floors" 
                                   Style="{StaticResource TitleTextStyle}"
                                   Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
                        <TextBlock Text="Manage floor layouts" 
                                   Style="{StaticResource CaptionTextStyle}"
                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                   Margin="0,4,0,0"/>
                    </StackPanel>
                    
                    <!-- Floors List -->
                    <ListView Grid.Row="1"
                               ItemsSource="{Binding Floors}"
                               SelectedItem="{Binding SelectedFloor, Mode=TwoWay}"
                               SelectionMode="Single"
                               Style="{StaticResource FluentListViewStyle}">
                        <ListView.ItemTemplate>
                            <DataTemplate>
                                <Grid Padding="12,8" Margin="8,4">
                                    <Grid.ColumnDefinitions>
                                        <ColumnDefinition Width="*"/>
                                        <ColumnDefinition Width="Auto"/>
                                    </Grid.ColumnDefinitions>
                                    
                                    <StackPanel Grid.Column="0">
                                        <TextBlock Text="{Binding FloorName}" 
                                                   FontWeight="SemiBold"
                                                   Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
                                        <TextBlock Text="{Binding Description}" 
                                                   Style="{StaticResource CaptionTextStyle}"
                                                   Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                   TextTrimming="CharacterEllipsis"
                                                   MaxLines="1"/>
                                        <StackPanel Orientation="Horizontal" Spacing="8" Margin="0,4,0,0">
                                            <TextBlock Text="{Binding TableCount, Converter={StaticResource TableCountConverter}}" 
                                                       Style="{StaticResource CaptionTextStyle}"
                                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"/>
                                            <Border Background="{ThemeResource SystemFillColorAttentionBackground}"
                                                    CornerRadius="4"
                                                    Padding="4,2"
                                                    Visibility="{Binding IsDefault, Converter={StaticResource BoolToVisibility}}">
                                                <TextBlock Text="Default" 
                                                           FontSize="10"
                                                           Foreground="White"
                                                           FontWeight="SemiBold"/>
                                            </Border>
                                        </StackPanel>
                                    </StackPanel>
                                    
                                    <Button Grid.Column="1"
                                            Content="&#xE712;"
                                            FontFamily="Segoe MDL2 Assets"
                                            FontSize="16"
                                            Background="Transparent"
                                            BorderThickness="0"
                                            Padding="8"
                                            Click="FloorMenu_Click"
                                            Tag="{Binding}">
                                        <Button.Flyout>
                                            <MenuFlyout>
                                                <MenuFlyoutItem Text="Rename" Click="RenameFloor_Click"/>
                                                <MenuFlyoutItem Text="Duplicate" Click="DuplicateFloor_Click"/>
                                                <MenuFlyoutSeparator/>
                                                <MenuFlyoutItem Text="Delete" Click="DeleteFloor_Click"/>
                                            </MenuFlyout>
                                        </Button.Flyout>
                                    </Button>
                                </Grid>
                            </DataTemplate>
                        </ListView.ItemTemplate>
                    </ListView>
                </Grid>
            </Border>
            
            <!-- Center: Layout Designer Canvas -->
            <Grid Grid.Column="1" Background="{ThemeResource SolidBackgroundFillColorBaseBrush}">
                <controls:LayoutDesigner x:Name="LayoutDesignerControl"
                                         Tables="{Binding Tables}"
                                         ZoomLevel="{Binding ZoomLevel, Mode=TwoWay}"
                                         GridSize="{Binding LayoutSettings.GridSize}"
                                         ShowGrid="True"
                                         SnapToGrid="{Binding LayoutSettings.SnapToGrid}"
                                         TableSelected="LayoutDesigner_TableSelected"
                                         TablePositionChanged="LayoutDesigner_TablePositionChanged"
                                         AddTableRequested="LayoutDesigner_AddTableRequested"/>
            </Grid>
            
            <!-- Right: Properties Panel -->
            <Border Grid.Column="2"
                    Background="{StaticResource AcrylicElevatedBrush}"
                    BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                    BorderThickness="1,0,0,0">
                <ScrollViewer VerticalScrollBarVisibility="Auto">
                    <StackPanel Padding="16" Spacing="16">
                        <!-- Panel Header -->
                        <TextBlock Text="Table Properties" 
                                   Style="{StaticResource TitleTextStyle}"
                                   Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
                        
                        <!-- No Selection State -->
                        <StackPanel x:Name="NoSelectionPanel" 
                                    Visibility="{Binding SelectedTable, Converter={StaticResource NullToVisibilityConverter}}"
                                    Spacing="8">
                            <TextBlock Text="Select a table to edit properties" 
                                       Style="{StaticResource BodyTextStyle}"
                                       Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                       TextAlignment="Center"
                                       Margin="0,32"/>
                        </StackPanel>
                        
                        <!-- Table Properties Form -->
                        <StackPanel x:Name="PropertiesPanel"
                                    Visibility="{Binding SelectedTable, Converter={StaticResource NotNullToVisibilityConverter}}"
                                    Spacing="16">
                            <!-- Basic Info -->
                            <Expander Header="Basic Information" IsExpanded="True" Style="{StaticResource FluentExpanderStyle}">
                                <StackPanel Spacing="12" Padding="12">
                                    <TextBox Header="Table Name" 
                                             Text="{Binding SelectedTable.TableName, Mode=TwoWay}"
                                             Style="{StaticResource FluentTextBoxStyle}"/>
                                    <TextBox Header="Table Number" 
                                             Text="{Binding SelectedTable.TableNumber, Mode=TwoWay}"
                                             Style="{StaticResource FluentTextBoxStyle}"/>
                                    <ComboBox Header="Table Type"
                                              SelectedItem="{Binding SelectedTable.TableType, Mode=TwoWay}"
                                              Style="{StaticResource FluentComboBoxStyle}">
                                        <ComboBoxItem Content="Bar" Tag="bar"/>
                                        <ComboBoxItem Content="Billiard" Tag="billiard"/>
                                    </ComboBox>
                                    <ComboBox Header="Size"
                                              SelectedItem="{Binding SelectedTable.Size, Mode=TwoWay}"
                                              Style="{StaticResource FluentComboBoxStyle}">
                                        <ComboBoxItem Content="Small" Tag="S"/>
                                        <ComboBoxItem Content="Medium" Tag="M"/>
                                        <ComboBoxItem Content="Large" Tag="L"/>
                                    </ComboBox>
                                </StackPanel>
                            </Expander>
                            
                            <!-- Position & Rotation -->
                            <Expander Header="Position &amp; Rotation" IsExpanded="True" Style="{StaticResource FluentExpanderStyle}">
                                <StackPanel Spacing="12" Padding="12">
                                    <NumberBox Header="X Position"
                                               Value="{Binding SelectedTable.XPosition, Mode=TwoWay}"
                                               Style="{StaticResource FluentNumberBoxStyle}"/>
                                    <NumberBox Header="Y Position"
                                               Value="{Binding SelectedTable.YPosition, Mode=TwoWay}"
                                               Style="{StaticResource FluentNumberBoxStyle}"/>
                                    <NumberBox Header="Rotation (degrees)"
                                               Value="{Binding SelectedTable.Rotation, Mode=TwoWay}"
                                               Minimum="0"
                                               Maximum="360"
                                               Style="{StaticResource FluentNumberBoxStyle}"/>
                                    <ToggleSwitch Header="Lock Position"
                                                  IsOn="{Binding SelectedTable.IsLocked, Mode=TwoWay}"/>
                                </StackPanel>
                            </Expander>
                            
                            <!-- Billing & Settings -->
                            <Expander Header="Billing &amp; Settings" Style="{StaticResource FluentExpanderStyle}">
                                <StackPanel Spacing="12" Padding="12">
                                    <NumberBox Header="Billing Rate (per hour)"
                                               Value="{Binding SelectedTable.BillingRate, Mode=TwoWay}"
                                               Minimum="0"
                                               Style="{StaticResource FluentNumberBoxStyle}"/>
                                    <ToggleSwitch Header="Auto-start Timer"
                                                  IsOn="{Binding SelectedTable.AutoStartTimer, Mode=TwoWay}"/>
                                    <ComboBox Header="Status"
                                              SelectedItem="{Binding SelectedTable.Status, Mode=TwoWay}"
                                              Style="{StaticResource FluentComboBoxStyle}">
                                        <ComboBoxItem Content="Available" Tag="available"/>
                                        <ComboBoxItem Content="Occupied" Tag="occupied"/>
                                    </ComboBox>
                                </StackPanel>
                            </Expander>
                            
                            <!-- Actions -->
                            <StackPanel Spacing="8" Margin="0,8,0,0">
                                <Button Content="Duplicate Table" 
                                        Style="{StaticResource FluentSecondaryButtonStyle}"
                                        Click="DuplicateTable_Click"/>
                                <Button Content="Delete Table" 
                                        Style="{StaticResource FluentSecondaryButtonStyle}"
                                        Click="DeleteTable_Click"
                                        Foreground="{ThemeResource SystemFillColorCriticalBrush}"/>
                            </StackPanel>
                        </StackPanel>
                    </StackPanel>
                </ScrollViewer>
            </Border>
        </Grid>
        
        <!-- Loading Overlay -->
        <Border Grid.RowSpan="2"
                Background="#80000000"
                Visibility="{Binding IsLoading, Converter={StaticResource BoolToVisibility}}">
            <ProgressRing IsActive="True" 
                          Width="48" 
                          Height="48"
                          HorizontalAlignment="Center"
                          VerticalAlignment="Center"/>
        </Border>
        
        <!-- Error Message -->
        <InfoBar x:Name="ErrorInfoBar"
                 Grid.RowSpan="2"
                 IsOpen="{Binding ErrorMessage, Converter={StaticResource StringToBool}}"
                 Message="{Binding ErrorMessage}"
                 Severity="Error"
                 VerticalAlignment="Top"
                 Margin="16"
                 Style="{StaticResource FluentInfoBarStyle}"/>
    </Grid>
</Page>

