<UserControl
    x:Class="MagiDesk.Frontend.Controls.LayoutDesigner"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:conv="using:MagiDesk.Frontend.Converters"
    mc:Ignorable="d">
    
    <UserControl.Resources>
        <conv:StringToVisibilityConverter x:Key="StringToVisibility"/>
        <conv:StatusToColorConverter x:Key="StatusToColorConverter"/>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <conv:BoolToLockedBorderBrush x:Key="BoolToLockedBorderBrush"/>
        <conv:BoolToLockedBorderThickness x:Key="BoolToLockedBorderThickness"/>
        <conv:BoolToLockedOpacity x:Key="BoolToLockedOpacity"/>
        <conv:TableTypeToVisibilityConverter x:Key="TableTypeToVisibility"/>
    </UserControl.Resources>
    
    <Grid x:Name="RootGrid" Background="{ThemeResource SolidBackgroundFillColorBaseBrush}">
        <ScrollViewer x:Name="MainScrollViewer"
                      ZoomMode="Enabled"
                      MinZoomFactor="0.25"
                      MaxZoomFactor="4.0"
                      HorizontalScrollBarVisibility="Auto"
                      VerticalScrollBarVisibility="Auto"
                      HorizontalScrollMode="Enabled"
                      VerticalScrollMode="Enabled">
            <Canvas x:Name="DesignCanvas"
                    Background="{StaticResource AcrylicCardBrush}"
                    Width="2000"
                    Height="2000"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top">
                
                <!-- Grid Overlay -->
                <Canvas x:Name="GridOverlay" IsHitTestVisible="False"/>
                
                <!-- Tables Container -->
                <ItemsControl x:Name="TablesContainer">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    <ItemsControl.ItemContainerStyle>
                        <Style TargetType="ContentPresenter">
                            <Setter Property="Canvas.Left" Value="{Binding XPosition}"/>
                            <Setter Property="Canvas.Top" Value="{Binding YPosition}"/>
                        </Style>
                    </ItemsControl.ItemContainerStyle>
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Border x:Name="TableBorder"
                                    Background="{ThemeResource ControlFillColorDefaultBrush}"
                                    BorderBrush="{Binding IsLocked, Converter={StaticResource BoolToLockedBorderBrush}}"
                                    BorderThickness="{Binding IsLocked, Converter={StaticResource BoolToLockedBorderThickness}}"
                                    CornerRadius="8"
                                    Padding="12"
                                    MinWidth="100"
                                    MinHeight="100"
                                    RenderTransformOrigin="0.5,0.5"
                                    Opacity="{Binding IsLocked, Converter={StaticResource BoolToLockedOpacity}}"
                                    Loaded="Table_Loaded"
                                    PointerPressed="Table_PointerPressed"
                                    PointerMoved="Table_PointerMoved"
                                    PointerReleased="Table_PointerReleased"
                                    PointerEntered="Table_PointerEntered"
                                    PointerExited="Table_PointerExited">
                                <Border.RenderTransform>
                                    <CompositeTransform Rotation="{Binding Rotation}"/>
                                </Border.RenderTransform>
                                
                                <Border.Shadow>
                                    <ThemeShadow/>
                                </Border.Shadow>
                                
                                <Grid>
                                    <!-- Table Visual Representation -->
                                    <Canvas>
                                        <!-- Billiard Table -->
                                        <Canvas x:Name="BilliardTableCanvas" 
                                                Visibility="{Binding TableType, Converter={StaticResource TableTypeToVisibility}, ConverterParameter=billiard}">
                                            <!-- Table Rails (Brown/Wood with gradient effect) -->
                                            <Rectangle Canvas.Left="0" Canvas.Top="0" 
                                                       Width="100" Height="100"
                                                       RadiusX="8" RadiusY="8">
                                                <Rectangle.Fill>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                        <GradientStop Color="#A0522D" Offset="0"/>
                                                        <GradientStop Color="#8B4513" Offset="0.5"/>
                                                        <GradientStop Color="#654321" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Rectangle.Fill>
                                            </Rectangle>
                                            
                                            <!-- Rail Inner Border (for depth) -->
                                            <Rectangle Canvas.Left="4" Canvas.Top="4" 
                                                       Width="92" Height="92"
                                                       RadiusX="6" RadiusY="6"
                                                       Stroke="#654321" StrokeThickness="1" Fill="Transparent"/>
                                            
                                            <!-- Felt Surface (Green with subtle gradient) -->
                                            <Rectangle Canvas.Left="8" Canvas.Top="8" 
                                                       Width="84" Height="84"
                                                       RadiusX="4" RadiusY="4">
                                                <Rectangle.Fill>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                        <GradientStop Color="#1B5E3E" Offset="0"/>
                                                        <GradientStop Color="#0F5132" Offset="0.5"/>
                                                        <GradientStop Color="#0A3D26" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Rectangle.Fill>
                                            </Rectangle>
                                            
                                            <!-- Corner Pockets (with depth effect) -->
                                            <Ellipse Canvas.Left="-2" Canvas.Top="-2" Width="14" Height="14" Fill="#1a1a1a"/>
                                            <Ellipse Canvas.Left="88" Canvas.Top="-2" Width="14" Height="14" Fill="#1a1a1a"/>
                                            <Ellipse Canvas.Left="-2" Canvas.Top="88" Width="14" Height="14" Fill="#1a1a1a"/>
                                            <Ellipse Canvas.Left="88" Canvas.Top="88" Width="14" Height="14" Fill="#1a1a1a"/>
                                            
                                            <!-- Side Pockets -->
                                            <Ellipse Canvas.Left="42" Canvas.Top="-2" Width="14" Height="14" Fill="#1a1a1a"/>
                                            <Ellipse Canvas.Left="42" Canvas.Top="88" Width="14" Height="14" Fill="#1a1a1a"/>
                                            
                                            <!-- Center Circle (spot) -->
                                            <Ellipse Canvas.Left="42" Canvas.Top="42" Width="16" Height="16" 
                                                     Stroke="#2d7a52" StrokeThickness="1.5" Fill="Transparent"/>
                                            
                                            <!-- Head Spot (for cue ball) -->
                                            <Ellipse Canvas.Left="20" Canvas.Top="42" Width="6" Height="6" Fill="White" Opacity="0.9"/>
                                            
                                            <!-- Foot Spot (for 8-ball) -->
                                            <Ellipse Canvas.Left="74" Canvas.Top="42" Width="6" Height="6" Fill="White" Opacity="0.9"/>
                                            
                                            <!-- Table felt texture lines (subtle) -->
                                            <Line Canvas.Left="8" Canvas.Top="50" X1="0" Y1="0" X2="84" Y2="0" 
                                                  Stroke="#1a7a4a" StrokeThickness="0.5" Opacity="0.3"/>
                                            <Line Canvas.Left="50" Canvas.Top="8" X1="0" Y1="0" X2="0" Y2="84" 
                                                  Stroke="#1a7a4a" StrokeThickness="0.5" Opacity="0.3"/>
                                        </Canvas>
                                        
                                        <!-- Bar Table with Chairs -->
                                        <Canvas x:Name="BarTableCanvas" 
                                                Visibility="{Binding TableType, Converter={StaticResource TableTypeToVisibility}, ConverterParameter=bar}">
                                            <!-- Table Top (Round with wood grain effect) -->
                                            <Ellipse Canvas.Left="20" Canvas.Top="20" 
                                                    Width="60" Height="60"
                                                    Stroke="#4a2c1a" StrokeThickness="2">
                                                <Ellipse.Fill>
                                                    <RadialGradientBrush>
                                                        <GradientStop Color="#8B6F47" Offset="0"/>
                                                        <GradientStop Color="#654321" Offset="0.7"/>
                                                        <GradientStop Color="#4a2c1a" Offset="1"/>
                                                    </RadialGradientBrush>
                                                </Ellipse.Fill>
                                            </Ellipse>
                                            
                                            <!-- Table Top Inner Highlight -->
                                            <Ellipse Canvas.Left="25" Canvas.Top="25" 
                                                    Width="50" Height="50"
                                                    Stroke="#A0826D" StrokeThickness="1" 
                                                    Opacity="0.4" Fill="Transparent"/>
                                            
                                            <!-- Table Base/Pedestal (with gradient) -->
                                            <Ellipse Canvas.Left="45" Canvas.Top="70" 
                                                    Width="10" Height="20">
                                                <Ellipse.Fill>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                        <GradientStop Color="#5a3d2a" Offset="0"/>
                                                        <GradientStop Color="#4a2c1a" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Ellipse.Fill>
                                            </Ellipse>
                                            
                                            <!-- Chairs around table (4 chairs positioned nicely) -->
                                            <!-- Top Chair -->
                                            <Ellipse Canvas.Left="43" Canvas.Top="5" Width="14" Height="14" Fill="#8B4513" Opacity="0.9"/>
                                            <Ellipse Canvas.Left="45" Canvas.Top="7" Width="10" Height="10" Fill="#A0522D" Opacity="0.6"/>
                                            <Rectangle Canvas.Left="47" Canvas.Top="16" Width="6" Height="10" Fill="#654321" RadiusX="1" RadiusY="1"/>
                                            
                                            <!-- Bottom Chair -->
                                            <Ellipse Canvas.Left="43" Canvas.Top="81" Width="14" Height="14" Fill="#8B4513" Opacity="0.9"/>
                                            <Ellipse Canvas.Left="45" Canvas.Top="83" Width="10" Height="10" Fill="#A0522D" Opacity="0.6"/>
                                            <Rectangle Canvas.Left="47" Canvas.Top="74" Width="6" Height="10" Fill="#654321" RadiusX="1" RadiusY="1"/>
                                            
                                            <!-- Left Chair -->
                                            <Ellipse Canvas.Left="3" Canvas.Top="43" Width="14" Height="14" Fill="#8B4513" Opacity="0.9"/>
                                            <Ellipse Canvas.Left="5" Canvas.Top="45" Width="10" Height="10" Fill="#A0522D" Opacity="0.6"/>
                                            <Rectangle Canvas.Left="14" Canvas.Top="47" Width="10" Height="6" Fill="#654321" RadiusX="1" RadiusY="1"/>
                                            
                                            <!-- Right Chair -->
                                            <Ellipse Canvas.Left="83" Canvas.Top="43" Width="14" Height="14" Fill="#8B4513" Opacity="0.9"/>
                                            <Ellipse Canvas.Left="85" Canvas.Top="45" Width="10" Height="10" Fill="#A0522D" Opacity="0.6"/>
                                            <Rectangle Canvas.Left="76" Canvas.Top="47" Width="10" Height="6" Fill="#654321" RadiusX="1" RadiusY="1"/>
                                        </Canvas>
                                    </Canvas>
                                    
                                    <!-- Overlay: Table Info -->
                                    <Grid VerticalAlignment="Bottom" Margin="4">
                                        <Border Background="{ThemeResource ControlFillColorSecondaryBrush}" 
                                                Opacity="0.95"
                                                CornerRadius="4"
                                                Padding="4,2"
                                                HorizontalAlignment="Stretch">
                                            <StackPanel>
                                                <!-- Table Name and Lock Icon -->
                                                <Grid>
                                                    <TextBlock Text="{Binding TableName}" 
                                                               FontWeight="SemiBold"
                                                               FontSize="11"
                                                               HorizontalAlignment="Center"
                                                               Foreground="{ThemeResource TextFillColorPrimaryBrush}"/>
                                                    <!-- Lock Icon -->
                                                    <FontIcon Glyph="&#xE72C;"
                                                              FontFamily="Segoe MDL2 Assets"
                                                              FontSize="10"
                                                              Foreground="{ThemeResource SystemFillColorCriticalBrush}"
                                                              HorizontalAlignment="Right"
                                                              VerticalAlignment="Top"
                                                              Visibility="{Binding IsLocked, Converter={StaticResource BoolToVisibility}}"
                                                              Margin="0,-2,-2,0"/>
                                                </Grid>
                                                
                                                <!-- Table Number -->
                                                <TextBlock Text="{Binding TableNumber}" 
                                                           FontSize="9"
                                                           HorizontalAlignment="Center"
                                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                           Visibility="{Binding TableNumber, Converter={StaticResource StringToVisibility}}"
                                                           Margin="0,1,0,0"/>
                                                
                                                <!-- Status Badge -->
                                                <Border Background="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                                        CornerRadius="3"
                                                        Padding="4,2"
                                                        Margin="0,2,0,0"
                                                        HorizontalAlignment="Center">
                                                    <TextBlock Text="{Binding Status}"
                                                               FontSize="9"
                                                               Foreground="White"
                                                               FontWeight="SemiBold"/>
                                                </Border>
                                            </StackPanel>
                                        </Border>
                                    </Grid>
                                </Grid>
                            </Border>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Canvas>
        </ScrollViewer>
        
        <!-- Zoom Controls -->
        <Border Background="{StaticResource AcrylicElevatedBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="8"
                HorizontalAlignment="Right"
                VerticalAlignment="Top"
                Margin="16"
                MinWidth="120">
            <StackPanel Orientation="Horizontal" Spacing="8" HorizontalAlignment="Center">
                <Button Content="âˆ’" 
                        Click="ZoomOut_Click"
                        Style="{StaticResource FluentSecondaryButtonStyle}"
                        Width="36"
                        Height="36"
                        FontSize="18"
                        FontWeight="Bold"/>
                <TextBlock x:Name="ZoomLevelText"
                           VerticalAlignment="Center"
                           MinWidth="50"
                           TextAlignment="Center"
                           Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                           FontWeight="SemiBold"/>
                <Button Content="+" 
                        Click="ZoomIn_Click"
                        Style="{StaticResource FluentSecondaryButtonStyle}"
                        Width="36"
                        Height="36"
                        FontSize="18"
                        FontWeight="Bold"/>
            </StackPanel>
        </Border>
        
        <!-- Toolbox -->
        <Border Background="{StaticResource AcrylicElevatedBrush}"
                BorderBrush="{ThemeResource CardStrokeColorDefaultBrush}"
                BorderThickness="1"
                CornerRadius="8"
                Padding="12"
                HorizontalAlignment="Left"
                VerticalAlignment="Top"
                Margin="16,80,0,0"
                MinWidth="140">
            <StackPanel Spacing="8">
                <TextBlock Text="Add Table" 
                           Style="{StaticResource SubtitleTextStyle}"
                           Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                           Margin="0,0,0,4"/>
                <Button Content="Bar Table" 
                        Style="{StaticResource FluentSecondaryButtonStyle}"
                        Click="AddBarTable_Click"
                        Tag="bar"
                        HorizontalAlignment="Stretch"/>
                <Button Content="Billiard Table" 
                        Style="{StaticResource FluentSecondaryButtonStyle}"
                        Click="AddBilliardTable_Click"
                        Tag="billiard"
                        HorizontalAlignment="Stretch"/>
            </StackPanel>
        </Border>
    </Grid>
</UserControl>

