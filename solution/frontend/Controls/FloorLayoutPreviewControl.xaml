<UserControl
    x:Class="MagiDesk.Frontend.Controls.FloorLayoutPreviewControl"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:conv="using:MagiDesk.Frontend.Converters"
    mc:Ignorable="d">
    
    <UserControl.Resources>
        <conv:StringToVisibilityConverter x:Key="StringToVisibility"/>
        <conv:StatusToColorConverter x:Key="StatusToColorConverter"/>
        <conv:BoolToVisibilityConverter x:Key="BoolToVisibility"/>
        <conv:TableTypeToVisibilityConverter x:Key="TableTypeToVisibility"/>
    </UserControl.Resources>
    
    <Grid x:Name="RootGrid" Background="{ThemeResource SolidBackgroundFillColorBaseBrush}">
        <ScrollViewer x:Name="MainScrollViewer"
                      ZoomMode="Enabled"
                      MinZoomFactor="0.1"
                      MaxZoomFactor="4.0"
                      HorizontalScrollBarVisibility="Disabled"
                      VerticalScrollBarVisibility="Disabled"
                      HorizontalScrollMode="Disabled"
                      VerticalScrollMode="Disabled">
            <Canvas x:Name="DesignCanvas"
                    Background="{StaticResource AcrylicCardBrush}"
                    Width="2000"
                    Height="2000"
                    HorizontalAlignment="Left"
                    VerticalAlignment="Top">
                
                <!-- Grid Overlay (optional) -->
                <Canvas x:Name="GridOverlay" IsHitTestVisible="False"/>
                
                <!-- Tables Container -->
                <ItemsControl x:Name="TablesContainer">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <Canvas/>
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                    
                    <ItemsControl.ItemTemplate>
                        <DataTemplate>
                            <Grid MinWidth="100" MinHeight="100" 
                                  RenderTransformOrigin="0.5,0.5"
                                  PointerPressed="Table_PointerPressed"
                                  RightTapped="Table_RightTapped"
                                  IsRightTapEnabled="True">
                                <Grid.RenderTransform>
                                    <CompositeTransform Rotation="{Binding Rotation}"/>
                                </Grid.RenderTransform>
                                
                                <Grid.ContextFlyout>
                                    <MenuFlyout x:Name="TableContextMenu" Opening="TableContextMenu_Opening">
                                        <!-- Billiard Table Specific: Start/Stop Session -->
                                        <MenuFlyoutItem x:Name="StartSessionMenuItem" 
                                                        Text="Start Session" 
                                                        Click="StartSessionMenu_Click"
                                                        Icon="Play"/>
                                        <MenuFlyoutItem x:Name="StopSessionMenuItem" 
                                                        Text="Stop Session" 
                                                        Click="StopSessionMenu_Click"
                                                        Icon="Cancel"/>
                                        
                                        <!-- Bar Table Specific: Open/Close Table -->
                                        <MenuFlyoutItem x:Name="OpenTableMenuItem" 
                                                        Text="Open Table" 
                                                        Click="OpenTableMenu_Click"
                                                        Icon="Play"/>
                                        <MenuFlyoutItem x:Name="CloseTableMenuItem" 
                                                        Text="Close Table" 
                                                        Click="CloseTableMenu_Click"
                                                        Icon="Cancel"/>
                                        
                                        <!-- Common: Add Items -->
                                        <MenuFlyoutItem Text="Add Items" 
                                                        Click="AddItemsMenu_Click"
                                                        Icon="Add"/>
                                        
                                        <!-- Bar Table Specific: Check Summary -->
                                        <MenuFlyoutItem x:Name="CheckSummaryMenuItem" 
                                                        Text="Check Summary" 
                                                        Click="CheckSummaryMenu_Click"
                                                        Icon="View"/>
                                        
                                        <!-- Common: Move Table -->
                                        <MenuFlyoutItem Text="Move Table" 
                                                        Click="MoveTableMenu_Click"
                                                        Icon="Forward"/>
                                        
                                        <!-- Bar Table Specific: Assign to Billiard Table -->
                                        <MenuFlyoutItem x:Name="AssignToBilliardMenuItem" 
                                                        Text="Assign to Billiard Table" 
                                                        Click="AssignToBilliardMenu_Click"
                                                        Icon="Forward"/>
                                        
                                        <MenuFlyoutSeparator/>
                                        
                                        <!-- Common: Table Status -->
                                        <MenuFlyoutItem Text="Table Status" 
                                                        Click="TableStatusMenu_Click"
                                                        Icon="Help"/>
                                        
                                        <MenuFlyoutSeparator/>
                                        
                                        <!-- Billiard Table Specific: Threshold Management -->
                                        <MenuFlyoutItem x:Name="SetThresholdMenuItem" 
                                                        Text="Set Threshold" 
                                                        Click="SetThresholdMenu_Click"
                                                        Icon="Clock"/>
                                        <MenuFlyoutItem x:Name="ClearThresholdMenuItem" 
                                                        Text="Clear Threshold" 
                                                        Click="ClearThresholdMenu_Click"
                                                        Icon="Clear"/>
                                        
                                        <MenuFlyoutSeparator/>
                                        
                                        <!-- Common: Diagnostics -->
                                        <MenuFlyoutItem Text="Run Diagnostics" 
                                                        Click="DiagnosticsMenu_Click"
                                                        Icon="Repair"/>
                                    </MenuFlyout>
                                </Grid.ContextFlyout>
                                
                                <!-- Status indicator ring -->
                                <Border BorderBrush="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                        BorderThickness="3"
                                        CornerRadius="8"
                                        Opacity="0.5"
                                        IsHitTestVisible="False"
                                        Margin="-6"/>
                                
                                <Grid>
                                    <!-- Table Visual Representation -->
                                    <Canvas>
                                        <!-- Billiard Table -->
                                        <Canvas Visibility="{Binding TableType, Converter={StaticResource TableTypeToVisibility}, ConverterParameter=billiard}">
                                            <!-- Table Rails -->
                                            <Rectangle Canvas.Left="0" Canvas.Top="0" 
                                                       Width="100" Height="100"
                                                       RadiusX="8" RadiusY="8">
                                                <Rectangle.Fill>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                        <GradientStop Color="#A0522D" Offset="0"/>
                                                        <GradientStop Color="#8B4513" Offset="0.5"/>
                                                        <GradientStop Color="#654321" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Rectangle.Fill>
                                            </Rectangle>
                                            
                                            <!-- Rail Inner Border -->
                                            <Rectangle Canvas.Left="4" Canvas.Top="4" 
                                                       Width="92" Height="92"
                                                       RadiusX="6" RadiusY="6"
                                                       Stroke="#654321" StrokeThickness="1" Fill="Transparent"/>
                                            
                                            <!-- Felt Surface -->
                                            <Rectangle Canvas.Left="8" Canvas.Top="8" 
                                                       Width="84" Height="84"
                                                       RadiusX="4" RadiusY="4">
                                                <Rectangle.Fill>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="1,1">
                                                        <GradientStop Color="#1B5E3E" Offset="0"/>
                                                        <GradientStop Color="#0F5132" Offset="0.5"/>
                                                        <GradientStop Color="#0A3D26" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Rectangle.Fill>
                                            </Rectangle>
                                            
                                            <!-- Corner Pockets -->
                                            <Ellipse Canvas.Left="-2" Canvas.Top="-2" Width="14" Height="14" Fill="#1a1a1a"/>
                                            <Ellipse Canvas.Left="88" Canvas.Top="-2" Width="14" Height="14" Fill="#1a1a1a"/>
                                            <Ellipse Canvas.Left="-2" Canvas.Top="88" Width="14" Height="14" Fill="#1a1a1a"/>
                                            <Ellipse Canvas.Left="88" Canvas.Top="88" Width="14" Height="14" Fill="#1a1a1a"/>
                                            
                                            <!-- Side Pockets -->
                                            <Ellipse Canvas.Left="42" Canvas.Top="-2" Width="14" Height="14" Fill="#1a1a1a"/>
                                            <Ellipse Canvas.Left="42" Canvas.Top="88" Width="14" Height="14" Fill="#1a1a1a"/>
                                            
                                            <!-- Center Circle -->
                                            <Ellipse Canvas.Left="42" Canvas.Top="42" Width="16" Height="16" 
                                                     Stroke="#2d7a52" StrokeThickness="1.5" Fill="Transparent"/>
                                            
                                            <!-- Spots -->
                                            <Ellipse Canvas.Left="20" Canvas.Top="42" Width="6" Height="6" Fill="White" Opacity="0.9"/>
                                            <Ellipse Canvas.Left="74" Canvas.Top="42" Width="6" Height="6" Fill="White" Opacity="0.9"/>
                                            
                                            <!-- Texture lines -->
                                            <Line Canvas.Left="8" Canvas.Top="50" X1="0" Y1="0" X2="84" Y2="0" 
                                                  Stroke="#1a7a4a" StrokeThickness="0.5" Opacity="0.3"/>
                                            <Line Canvas.Left="50" Canvas.Top="8" X1="0" Y1="0" X2="0" Y2="84" 
                                                  Stroke="#1a7a4a" StrokeThickness="0.5" Opacity="0.3"/>
                                        </Canvas>
                                        
                                        <!-- Bar Table with Chairs -->
                                        <Canvas Visibility="{Binding TableType, Converter={StaticResource TableTypeToVisibility}, ConverterParameter=bar}">
                                            <!-- Table Top -->
                                            <Ellipse Canvas.Left="20" Canvas.Top="20" 
                                                    Width="60" Height="60"
                                                    Stroke="#4a2c1a" StrokeThickness="2">
                                                <Ellipse.Fill>
                                                    <RadialGradientBrush>
                                                        <GradientStop Color="#8B6F47" Offset="0"/>
                                                        <GradientStop Color="#654321" Offset="0.7"/>
                                                        <GradientStop Color="#4a2c1a" Offset="1"/>
                                                    </RadialGradientBrush>
                                                </Ellipse.Fill>
                                            </Ellipse>
                                            
                                            <!-- Table Top Inner Highlight -->
                                            <Ellipse Canvas.Left="25" Canvas.Top="25" 
                                                    Width="50" Height="50"
                                                    Stroke="#A0826D" StrokeThickness="1" 
                                                    Opacity="0.4" Fill="Transparent"/>
                                            
                                            <!-- Table Base -->
                                            <Ellipse Canvas.Left="45" Canvas.Top="70" 
                                                    Width="10" Height="20">
                                                <Ellipse.Fill>
                                                    <LinearGradientBrush StartPoint="0,0" EndPoint="0,1">
                                                        <GradientStop Color="#5a3d2a" Offset="0"/>
                                                        <GradientStop Color="#4a2c1a" Offset="1"/>
                                                    </LinearGradientBrush>
                                                </Ellipse.Fill>
                                            </Ellipse>
                                            
                                            <!-- Chairs -->
                                            <Ellipse Canvas.Left="43" Canvas.Top="5" Width="14" Height="14" Fill="#8B4513" Opacity="0.9"/>
                                            <Ellipse Canvas.Left="45" Canvas.Top="7" Width="10" Height="10" Fill="#A0522D" Opacity="0.6"/>
                                            <Rectangle Canvas.Left="47" Canvas.Top="16" Width="6" Height="10" Fill="#654321" RadiusX="1" RadiusY="1"/>
                                            
                                            <Ellipse Canvas.Left="43" Canvas.Top="81" Width="14" Height="14" Fill="#8B4513" Opacity="0.9"/>
                                            <Ellipse Canvas.Left="45" Canvas.Top="83" Width="10" Height="10" Fill="#A0522D" Opacity="0.6"/>
                                            <Rectangle Canvas.Left="47" Canvas.Top="74" Width="6" Height="10" Fill="#654321" RadiusX="1" RadiusY="1"/>
                                            
                                            <Ellipse Canvas.Left="3" Canvas.Top="43" Width="14" Height="14" Fill="#8B4513" Opacity="0.9"/>
                                            <Ellipse Canvas.Left="5" Canvas.Top="45" Width="10" Height="10" Fill="#A0522D" Opacity="0.6"/>
                                            <Rectangle Canvas.Left="14" Canvas.Top="47" Width="10" Height="6" Fill="#654321" RadiusX="1" RadiusY="1"/>
                                            
                                            <Ellipse Canvas.Left="83" Canvas.Top="43" Width="14" Height="14" Fill="#8B4513" Opacity="0.9"/>
                                            <Ellipse Canvas.Left="85" Canvas.Top="45" Width="10" Height="10" Fill="#A0522D" Opacity="0.6"/>
                                            <Rectangle Canvas.Left="76" Canvas.Top="47" Width="10" Height="6" Fill="#654321" RadiusX="1" RadiusY="1"/>
                                        </Canvas>
                                    </Canvas>
                                    
                                    <!-- Table Info Overlay -->
                                    <Grid VerticalAlignment="Bottom" 
                                          Margin="0,0,0,-40" 
                                          x:Name="TableInfoOverlay"
                                          HorizontalAlignment="Center">
                                        <Border Background="{ThemeResource ControlFillColorSecondaryBrush}" 
                                                Opacity="0.95"
                                                CornerRadius="6"
                                                Padding="8,4"
                                                x:Name="TableInfoBorder"
                                                MinWidth="80">
                                            <StackPanel Spacing="2">
                                                <TextBlock Text="{Binding TableName}" 
                                                           FontWeight="SemiBold"
                                                           FontSize="12"
                                                           HorizontalAlignment="Center"
                                                           Foreground="{ThemeResource TextFillColorPrimaryBrush}"
                                                           TextTrimming="CharacterEllipsis"
                                                           MaxWidth="100"/>
                                                
                                                <TextBlock Text="{Binding TableNumber}" 
                                                           FontSize="10"
                                                           HorizontalAlignment="Center"
                                                           Foreground="{ThemeResource TextFillColorSecondaryBrush}"
                                                           Visibility="{Binding TableNumber, Converter={StaticResource StringToVisibility}}"
                                                           TextTrimming="CharacterEllipsis"
                                                           MaxWidth="100"/>
                                                
                                                <Border Background="{Binding Status, Converter={StaticResource StatusToColorConverter}}"
                                                        CornerRadius="4"
                                                        Padding="6,3"
                                                        Margin="0,2,0,0"
                                                        HorizontalAlignment="Center"
                                                        x:Name="StatusBadge"
                                                        MinWidth="60">
                                                    <TextBlock x:Name="StatusTextBlock"
                                                               FontSize="10"
                                                               Foreground="White"
                                                               FontWeight="SemiBold"
                                                               HorizontalAlignment="Center"
                                                               Text="{Binding Status}"/>
                                                </Border>
                                            </StackPanel>
                                        </Border>
                                    </Grid>
                                </Grid>
                            </Grid>
                        </DataTemplate>
                    </ItemsControl.ItemTemplate>
                </ItemsControl>
            </Canvas>
        </ScrollViewer>
    </Grid>
</UserControl>
